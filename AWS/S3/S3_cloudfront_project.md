# プロジェクト：S3 + CloudFront によるセキュアな静的サイト配信基盤と CI/CD の構築

## 1. プロジェクトの概要

本プロジェクトでは、Amazon S3 と Amazon CloudFront を組み合わせた静的ウェブサイト配信インフラを構築しました。
単にファイルを公開するのではなく、**「S3バケットを非公開にし、特定の経路（CloudFront）からしかアクセスできないようにする」**という、実務で求められるセキュリティ設計を再現しています。さらに、GitHub へのプッシュをトリガーとした自動デプロイ環境（CI/CD）も実装しました。

## 2. 構築の目的

インフラエンジニアへのキャリアチェンジを目指す中で、以下の3点を自分の手で動かしながら習得することを目標としました。

-   **セキュリティ・ファーストの設計**: バケットをパブリック公開する安易な方法を避け、AWS 推奨のセキュアな設定（OAC）での構築に挑戦すること。
-   **IaC（インフラのコード化）の実践**: マネジメントコンソールでの手動構築による構造理解と、CloudFormation を使ったコード管理の両立。
-   **運用の自動化**: 「コードを直してプッシュすればサイトが変わる」という、実務レベルのデプロイフローを自力で作り上げること。

## 3. 使用した技術と選定理由

| 技術要素 | 選定理由 |
| :--- | :--- |
| Amazon S3 | 静的ファイルの保管場所。セキュリティ重視のため、バケットは外部から直接見られないよう完全に非公開に設定。 |
| Amazon CloudFront | 世界中への低遅延配信と HTTPS 通信の強制のため。アクセス制限の「玄関口」としての役割も兼任。 |
| Origin Access Control (OAC) | 非公開 S3 に対し、CloudFront からの正規の依頼だけを許可する最新の認証方式。 |
| CloudFormation | インフラ構成をコード化し、設定の意図をドキュメントとして残しつつ再現性を確保するため。 |
| CircleCI | GitHub と連携した自動テスト、S3 への同期、キャッシュクリアを自動化するため。 |

## 4. インフラ構築のプロセスと「壁」の乗り越え方

### ① 手を動かして分かったサービス同士の「繋がり」

まずはマネジメントコンソールを使って手動で構築し、各設定がどう影響し合っているのかを学びました。

-   **気づき**: CloudFront の「オリジン」設定と S3 の「バケットポリシー」が噛み合って初めてアクセスができる仕組みや、OAC が発行する「通行証（署名）」を S3 側でチェックする流れを視覚的に理解できました。

### ② 403 Access Denied との格闘

構築後、URLの末尾（/）にアクセスすると 403 エラーが発生する問題に直面しました。

-   **原因の特定**: 公開用の S3 設定と違い、今回のような非公開構成では S3 側が「 / を index.html と読み替える」機能を持っていないことが分かりました。
-   **解決方法**: CloudFront 側の DefaultRootObject に index.html を設定。これにより解決し、「どこで何の処理をさせるべきか」という境界線を深く理解できました。

## 5. CI/CD による運用自動化への挑戦

インフラ構築をゴールとせず、その後の運用をどれだけ楽に、かつミスなく行えるかを目指して CircleCI による自動化を行いました。

### ① 試行錯誤の末に辿り着いた「シンプルな構成」

当初はフォルダを細かく分けた複雑な構成に挑戦しましたが、パス指定が複雑になり CircleCI が設定ファイルを見失うエラーに直面しました。

「そもそも今の自分にこの複雑さは必要か？」と自問自答し、リポジトリ直下でのフラットな管理に再編。CircleCI の標準的な挙動を活かすことで、誰が見ても分かりやすい構成に辿り着きました。

### ② 技術的課題と解決策（トラブルシューティング記録）

| エラー内容 | 苦戦したポイントと原因の特定 | 解決策 |
| :--- | :--- | :--- |
| `error fetching config` | 設定ファイルがあるのに「見つからない」とエラー。フォルダ階層が深すぎて、CircleCI が読みに行く起点がズレていたのが原因でした。 | 構成をシンプルにするためファイルをリポジトリ直下へ移動。身の丈に合った構造に変えることで解消しました。 |
| `Invalid bucket name` | S3 同期時にバケット名が空になる。設定ファイル間（YAML）で、値を拾い上げるための「名前」が 1 文字だけズレていることに気づきました。 | `template.yml` と `config.yml` を一行ずつ見比べ、キー名を完全に一致させることで自動取得に成功しました。 |
| `Missing InvalidationBatch` | キャッシュクリアの指示が実行されない。AWS が「どのファイルを消すか」という具体的な指示（パス）を待っている状態だと理解しました。 | `--paths "/*"` オプションを追記。全ファイルを対象に更新するようコマンドを補完し、デプロイを完走させました。 |

### ③ 自動化フローのこだわり

単にファイルを送るだけでなく、「安全で綺麗なデプロイ」を意識しました。

-   **事前チェック (`cfn-lint`)**: 人的ミスを防ぐため、デプロイ前に設計図の構文や AWS ベストプラクティスを自動検証する仕組みを導入。
-   **スムーズな同期 (`s3 sync`)**: 変更ファイルのみを送り、さらに `--exclude` で `.git` や `.circleci` などの不要な管理ファイルが S3 に混入しないよう徹底しました。
-   **キャッシュ更新の自動化**: `aws cloudformation describe-stacks` を介して ID を動的に取得。手動作業を一切排除し、即座に最新サイトを届ける仕組みを構築しました。

## 6. 自己評価と学び

今回の構築を通じて、1 文字のスペルミスがシステムを止めてしまう IaC の厳密さを痛感しました。同時に、エラーメッセージを読み解き、一つひとつ原因を潰していくことで「プッシュするだけで安全にサイトが更新される」という一連のラインを完遂できたことは、大きな自信に繋がりました。

安易な方法を選ばず、一見複雑な「非公開＋署名付きアクセス」を自動化した経験を、今後の実務でも活かしていきたいと考えています。
